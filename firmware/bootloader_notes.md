# TMF Flight Controller Bootloader & Initialization Notes

---

## Overview

The TMF (Tango-Mike-Foxtrot) flight controller bootloader is designed to initialize hardware peripherals and prepare the environment for the custom flight firmware, which manages propulsion, stabilization, and telemetry for the drone.

Because of the complex EM interference environment generated by the plasma core and coil systems, the bootloader also includes diagnostic checks for signal integrity and electromagnetic shielding before handing control to the main firmware.

---

## Supported Hardware

- MCU: STM32F746ZG (Cortex-M7, 216 MHz, 1MB Flash, 320KB RAM)
- External SPI Flash: W25Q256JV for non-volatile data logging
- Power management ICs for regulated 3.3V and 5V rails
- IMU: BMI270 or equivalent with I2C/SPI interface
- Temperature sensors: MAX31855 thermocouple amplifiers on coil mounts
- Coil drivers via SPI-controlled DACs and gate drivers
- Secure element: ATECC608A for cryptographic hardware security

---

## Bootloader Phases

### 1. Power-On Reset (POR)

- Reset vector activated.
- Basic clock system init (HSE 8 MHz crystal to PLL @ 216 MHz).
- SRAM integrity check (CRC on boot RAM region).
- Power rails monitored for voltage stability (brownout detection).

### 2. Peripheral Initialization

- GPIO ports configured (input/output/AF for SPI, I2C, UART).
- SPI Flash chip detected and read ID verified.
- IMU initialized and self-test checked; fallback loop if IMU fails.
- Temperature sensors polled for safe operating baseline.

### 3. EMI/EMC Environment Validation

- Internal ADC measures ambient noise on power rails.
- Detects and logs EMI spikes that could affect coil firing.
- Shield grounding continuity check via GPIO inputs on Faraday mesh lines.
- If EMI exceeds threshold, bootloader enters safe halt with LED alert.

### 4. Firmware Integrity Check

- Calculates SHA-256 hash of main flight firmware binary in internal flash.
- Compares against stored signature in secure element.
- Rejects boot if tampering or corruption detected.

### 5. Bootloader UI & Communication

- UART exposed on debug pins (for dev mode).
- Status LED indicates boot stage (blinks in coded sequence).
- Optional firmware update over USB-DFU (device firmware upgrade).
- External command via UART allowed only if secure handshake passes.

### 6. Jump to Main Firmware

- On successful completion of all checks, jumps to flight firmware entry point.
- Bootloader stack pointer reset and vector table remapped to firmware.

---

## Fail-Safe & Recovery

- In case of failure at any stage, system halts with LED code.
- Requires physical reset and connection to debug UART.
- Bootloader supports safe rollback to last known good firmware from SPI Flash.

---

## Developer Notes

- Debug logs available over SWO pin at 2 Mbps.
- Low-level timing critical routines written in assembly for ISR.
- Watchdog timer enabled after peripheral init to avoid boot hangs.
- EMI detection thresholds configurable via OTP memory.

---

## Security Considerations

- Secure element handles private keys for firmware authentication.
- Firmware encryption planned for future releases.
- Physical tampering detection via accelerometer impact signature.

---

## References

- STM32F7 Reference Manual RM0385 Rev 12
- ATECC608A CryptoAuth Data Sheet
- BMI270 IMU Datasheet
- W25Q256JV SPI Flash Datasheet

---

*This document will be expanded as firmware develops.*

